!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SB Forge — Tally (Single Sheet)</title>
<style>
  :root { --gap: 12px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 14px; }
  header { display:flex; gap:8px; align-items:center; margin-bottom:10px; }
  h2 { margin:0; font-size:1.15rem; }
  button, input { font: inherit; }
  button { padding:8px 12px; border-radius:10px; border:1px solid #bbb; background:#fff; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .grid { display:grid; grid-template-columns:1fr; gap: var(--gap); }
  @media (min-width: 860px) { .grid { grid-template-columns: repeat(2, 1fr); } }
  .card { border:1px solid #e2e2e2; border-radius:12px; padding:12px; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0; flex-wrap:wrap; }
  .sku { font-weight:700; font-size:1.06rem; }
  .muted { color:#666; }
  .danger { color:#b00020; font-weight:600; }
  .qty { font-variant-numeric: tabular-nums; min-width:3ch; text-align:right; }
  .field { display:flex; gap:6px; align-items:center; }
  .field input[type="date"], .field input[type="number"] { padding:6px 8px; border:1px solid #bbb; border-radius:8px; width: 10rem; }
  .field input[type="number"] { width: 7rem; }
  .err { background:#fff3f3; color:#900; padding:10px; border:1px solid #f0c; border-radius:8px; white-space:pre-wrap; margin-top:10px; }
  .btnwrap { position:relative; display:inline-block; }
  .loading::after { content:""; position:absolute; inset:0; width:0%; background:rgba(0,0,0,0.08); animation:fill .7s linear forwards; border-radius:10px; }
  @keyframes fill { to { width:100%; } }
  .tools { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .qtyInput { width: 5rem; padding:6px 8px; border:1px solid #bbb; border-radius:8px; }
</style>
</head>
<body>
<header style="display:flex;justify-content:space-between;align-items:center;
               background:#2b2b2b;padding:10px 16px;border-bottom:1px solid #3d3d3d;">
  <h1 style="margin:0;color:#c4a25a;">SB Forge</h1>
  <nav style="display:flex;gap:8px;">
    <button id="tabInv" style="border:1px solid #c4a25a;color:#c4a25a;background:none;
                                padding:6px 12px;border-radius:6px;cursor:pointer;">Inventory</button>
    <button id="tabTally" style="border:1px solid #c4a25a;color:#c4a25a;background:none;
                                 padding:6px 12px;border-radius:6px;cursor:pointer;">Tally Tool</button>
  </nav>
</header>

<section id="inventory" style="display:none;background:#1e1e1e;color:#f2f2f2;padding:16px;">
  <div id="meta" style="color:#aaa;margin-bottom:8px;">Loading...</div>
  <div id="invApp"></div>
</section>

<section id="tally" style="display:none;background:#f8f8f9;color:#111;padding:16px;">
  <div class="wrap">
    <header>
      <h2 style="margin:0;">SBF Tally — Orders by Range (v4)</h2>
      <div class="btns">
        <button id="resetTallies">Reset Tallies</button>
        <button id="clearAll">Clear All</button>
        <button id="shipTallies">Shipped</button>
      </div>
    </header>
    <table class="table" id="table">
      <thead class="thead">
        <tr>
          <th>Product</th>
          <th>Letter</th>
          <th>Stock</th>
          <th>Tally</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <!-- keep your orders-panel code here if you already have it -->
  </div>
</section>


<script>
const API="/api/forward";
const SKU_ORDER=["Small","Large","Large + Helper","Roaster","XL","Spatula","Tongs"];
let invState=[];

async function getJSON(url){const r=await fetch(url);return r.json();}
async function postJSON(body){
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  return r.json();
}

async function loadInventory(){
  const meta=document.getElementById("meta");
  meta.textContent="Loading...";
  try{
    const data=await getJSON(`${API}?route=inventory`);
    invState=(data.inventory||[]).sort((a,b)=>SKU_ORDER.indexOf(a.SKU)-SKU_ORDER.indexOf(b.SKU));
    renderInventory();
    meta.textContent=`Loaded ${invState.length} SKUs • ${new Date().toLocaleTimeString()}`;
  }catch(e){
    console.error(e);
    meta.textContent="Error loading inventory";
  }
}

function weeksRemaining(goalDateStr){
  if(!goalDateStr) return null;
  const today=new Date(),goal=new Date(goalDateStr);
  if(isNaN(goal)) return null;
  return Math.max(0,Math.ceil((goal-today)/(1000*3600*24*7)));
}

function renderInventory(){
  const container=document.getElementById("invApp");
  container.innerHTML="";
  invState.forEach(r=>{
    const on=+r.On_Hand||0,res=+r.Reserved||0;
    const avail=Math.max(0,on-res);
    const goal=+r.Goal_Stock||0;
    const weeks=weeksRemaining(r.Goal_Date);
    const weekly=(goal&&weeks)?Math.ceil(Math.max(0,goal-avail)/weeks):"–";
    const pct=goal?Math.min(100,(avail/goal)*100):0;

    const card=document.createElement("div");
    card.style.cssText="background:#2b2b2b;border:1px solid #3d3d3d;border-radius:12px;padding:16px;margin-bottom:14px;";
    card.innerHTML=`
      <div style="color:#c4a25a;font-weight:700;font-size:1.1rem;">${r.SKU}</div>
      <div class='row'><span>On Hand</span><span>${on}</span></div>
      <div class='row'><span>Reserved</span><span>${res}</span></div>
      <div class='row'><span>Available</span><span>${avail}</span></div>
      <div class='row'><span>Goal Stock</span><span>${goal||"–"}</span></div>
      <div class='row'><span>Weeks Remaining</span><span>${weeks??"–"}</span></div>
      <div class='row' style="color:#c4a25a;font-weight:700;">
        <span>Weekly Build Needed</span><span>${weekly}</span>
      </div>
      <div style="background:#3d3d3d;height:8px;border-radius:4px;overflow:hidden;margin-top:4px;">
        <div style="height:100%;background:#d8b96a;width:${pct}%;transition:width .6s;"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        <div style="display:flex;align-items:center;gap:4px;">
          <button class="ctrl-btn" onclick="adjustQty('${r.SKU}',-1,this)">−</button>
          <input type="number" id="input-${r.SKU}" value="0" min="0" step="1"
                 style="width:60px;background:#2b2b2b;border:1px solid #3d3d3d;
                        color:#f2f2f2;border-radius:6px;text-align:center;padding:4px 6px;font-weight:700;">
          <button class="ctrl-btn" onclick="adjustQty('${r.SKU}',1,this)">+</button>
        </div>
        <button class="ctrl-btn" onclick="reserveQty('${r.SKU}',1,this)">Res</button>
        <button class="ctrl-btn" onclick="shipQty('${r.SKU}',1,this)">Ship</button>
      </div>
      <div style="margin-top:8px;">
        <label>Manual On-Hand:
          <input id="manual-${r.SKU}" type="number" value="${on}" min="0" step="1"
                 style="width:70px;background:#2b2b2b;border:1px solid #3d3d3d;
                        color:#f2f2f2;border-radius:6px;text-align:center;padding:4px 6px;font-weight:700;">
        </label>
        <button onclick="saveManual('${r.SKU}')"
                style="border:1px solid #c4a25a;color:#c4a25a;background:none;border-radius:6px;
                       padding:4px 8px;cursor:pointer;">Save</button>
      </div>`;
    container.appendChild(card);
  });
}

async function adjustQty(sku,delta,btn){
  animateBtn(btn);
  const val=parseInt(document.getElementById(`input-${sku}`).value||"0",10);
  const amt=Math.max(1,val||1)*delta;
  await postJSON({Action:"adjust",SKU:sku,Qty:amt});
  loadInventory();
}
async function reserveQty(sku,qty,btn){animateBtn(btn);await postJSON({Action:"reserve",SKU:sku,Qty:qty});loadInventory();}
async function shipQty(sku,qty,btn){animateBtn(btn);await postJSON({Action:"ship",SKU:sku,Qty:qty});loadInventory();}
async function saveManual(sku){
  const val=parseInt(document.getElementById(`manual-${sku}`).value||"0",10);
  await postJSON({Action:"set_onhand",SKU:sku,Qty:val});
  loadInventory();
}
function animateBtn(b){
  b.style.position="relative";
  const fill=document.createElement("div");
  fill.style.cssText="position:absolute;inset:0;background:#c4a25a;opacity:.2;width:0%;";
  b.appendChild(fill);
  b.disabled=true;
  requestAnimationFrame(()=>fill.style.width="100%");
  setTimeout(()=>{b.disabled=false;b.removeChild(fill);},800);
}
</script>

<script>
// === Forge Tally Tool (connected) ===
const API = "/api/forward";
async function getJSON(url){ const r = await fetch(url); return r.json(); }
async function postJSON(body){
  const r = await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  return r.json();
}

const ITEMS = [
  { key:'small', name:'Small', code:'S' },
  { key:'large', name:'Large', code:'L' },
  { key:'large_helper', name:'Large + Helper', code:'LH' },
  { key:'roaster', name:'Roaster', code:'R' },
  { key:'xl', name:'XL', code:'XL' },
  { key:'spatula', name:'Spatula', code:'SP' },
  { key:'tong', name:'Tongs', code:'T' },
];

const tbody = document.getElementById('tbody');

// === Build rows ===
function renderTally(){
  tbody.innerHTML="";
  for(const item of ITEMS){
    const tr=document.createElement('tr');
    tr.className='row'; tr.dataset.item=item.key;
    tr.innerHTML=`
      <td>${item.name}</td>
      <td style="text-align:center">${item.code}</td>
      <td style="text-align:center"><input type="number" data-field="${item.key}:stock" value="0"></td>
      <td style="text-align:center">
        <button onclick="tallyStep('${item.key}',-1,this)">−</button>
        <span data-field="${item.key}:tally" style="margin:0 8px;">0</span>
        <button onclick="tallyStep('${item.key}',1,this)">+</button>
      </td>`;
    tbody.appendChild(tr);
  }
}
renderTally();

// === Sync with Google Sheet ===
async function loadLiveStock(){
  try{
    const data=await getJSON(`${API}?route=inventory`);
    const inv=data.inventory||[];
    for(const item of ITEMS){
      const row=tbody.querySelector(`.row[data-item="${item.key}"]`);
      const stockInput=row?.querySelector(`[data-field="${item.key}:stock"]`);
      const match=inv.find(x=>x.SKU.toLowerCase().includes(item.name.toLowerCase()));
      if(match && stockInput){ stockInput.value=match.On_Hand||0; }
    }
  }catch(e){ console.error("Load stock failed",e); }
}

function tallyStep(key,delta,btn){
  const el=tbody.querySelector(`[data-field="${key}:tally"]`);
  let n=parseInt(el.textContent||"0",10)||0;
  n=Math.max(0,n+delta);
  el.textContent=n;
  btn.style.position="relative";
  const bar=document.createElement("div");
  bar.style.cssText="position:absolute;left:0;bottom:0;height:3px;width:0;background:linear-gradient(90deg,#60a5fa,#34d399);transition:width 10s linear;";
  btn.appendChild(bar);
  requestAnimationFrame(()=>bar.style.width="100%");
  setTimeout(()=>bar.remove(),10000);
}

document.getElementById("resetTallies").onclick=()=>{
  if(!confirm("Reset all tallies to 0?"))return;
  for(const item of ITEMS){
    const el=tbody.querySelector(`[data-field="${item.key}:tally"]`);
    el.textContent='0';
  }
};
document.getElementById("clearAll").onclick=()=>{
  if(!confirm("Clear all stock and tallies?"))return;
  for(const item of ITEMS){
    tbody.querySelector(`[data-field="${item.key}:stock"]`).value='';
    tbody.querySelector(`[data-field="${item.key}:tally"]`).textContent='0';
  }
};
document.getElementById("shipTallies").onclick=shipTallies;

async function shipTallies(){
  if(!confirm("Confirm ship tallied quantities?"))return;
  const payloads=[];
  for(const item of ITEMS){
    const n=parseInt(tbody.querySelector(`[data-field="${item.key}:tally"]`).textContent||"0",10)||0;
    if(n>0) payloads.push({Action:"ship",SKU:item.name,Qty:n});
  }
  if(payloads.length===0){alert("No tallies to ship.");return;}
  try{
    await Promise.all(payloads.map(p=>postJSON(p)));
    alert("Shipment logged ✅");
    loadLiveStock();
    for(const item of ITEMS){
      tbody.querySelector(`[data-field="${item.key}:tally"]`).textContent='0';
    }
  }catch(e){console.error(e);alert("Error shipping");}
}

// Auto-load when tab opened
loadLiveStock();
</script>





<script>
document.getElementById("tabInv").onclick = () => switchTab("inventory");
document.getElementById("tabTally").onclick = () => switchTab("tally");

function switchTab(tab){
  document.getElementById("inventory").style.display = (tab==="inventory") ? "block" : "none";
  document.getElementById("tally").style.display = (tab==="tally") ? "block" : "none";

  document.body.style.background = (tab==="inventory") ? "#1e1e1e" : "#f8f8f9";
  document.body.style.color = (tab==="inventory") ? "#f2f2f2" : "#111";

  if(tab==="inventory") loadInventory();
  if(tab==="tally") loadLiveStock();
}
</script>
</body>
</html>
