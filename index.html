<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SB Forge Inventory & Tally Tool</title>
<style>
  :root {
    --brass: #b99a5a;
    --gray-bg: #1e1e1e;
    --light-bg: #fafafa;
    --card-bg: #2b2b2b;
    --text-light: #f2f2f2;
    --muted: #aaa;
  }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color: var(--text-light);
    background: var(--gray-bg);
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-bg);
    padding: 10px 16px;
    border-bottom: 1px solid #444;
  }
  header h1 {
    font-size: 1.1rem;
    margin: 0;
    color: var(--brass);
  }
  nav {
    display: flex;
    gap: 8px;
  }
  nav button {
    background: none;
    border: 1px solid var(--brass);
    color: var(--brass);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  nav button.active {
    background: var(--brass);
    color: var(--gray-bg);
  }
  #refreshBtn {
    border: 1px solid var(--brass);
    color: var(--brass);
    background: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  /* Inventory Tab */
  #inventory {
    padding: 16px;
    display: none;
  }
  .card {
    background: var(--card-bg);
    border: 1px solid #3d3d3d;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
  }
  .sku {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--brass);
  }
  .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
  }
  .qty {
    font-variant-numeric: tabular-nums;
  }
  .bar-container {
    background: #3d3d3d;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    background: var(--brass);
    width: 0%;
    transition: width 0.5s ease;
  }
  .tally-btn {
    border: 1px solid var(--brass);
    background: none;
    color: var(--brass);
    padding: 10px;
    width: 46px;
    height: 46px;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .tally-btn.loading::after {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--brass);
    opacity: 0.2;
    width: 0%;
    animation: fill 0.8s linear forwards;
  }
  @keyframes fill { to { width: 100%; } }

  /* Tally Tab (light) */
  #tally {
    background: var(--light-bg);
    color: #222;
    padding: 16px;
    display: none;
    min-height: 100vh;
  }
  .tally-box {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .tally-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .tally-controls input[type="number"] {
    width: 90px;
    padding: 6px;
  }
  .tally-output {
    font-family: monospace;
    white-space: pre-wrap;
  }
  .checked {
    text-decoration: line-through;
    color: red;
  }
</style>
</head>
<body>
<header>
  <h1>SB Forge</h1>
  <nav>
    <button id="tabInv" class="active">Inventory</button>
    <button id="tabTally">Tally Tool</button>
  </nav>
  <button id="refreshBtn">Refresh</button>
</header>

<section id="inventory">
  <div id="meta" class="row" style="color:var(--muted); margin-bottom:8px;">Loading...</div>
  <div id="invApp"></div>
</section>

<section id="tally">
  <div class="tally-box">
    <h2>Tally Tool</h2>
    <div class="tally-controls">
      <label>Start: <input type="number" id="startNum" value="100"></label>
      <label>End: <input type="number" id="endNum" value="110"></label>
      <button onclick="generateList()">Generate</button>
    </div>
    <div id="checkboxes"></div>
    <h3>Readout:</h3>
    <div class="tally-output" id="readout"></div>
  </div>
</section>

<script>
const API = "/api/forward"; // uses Vercel proxy

let invState = [];
let localGoals = new Map();

document.getElementById("tabInv").onclick = () => switchTab("inventory");
document.getElementById("tabTally").onclick = () => switchTab("tally");
document.getElementById("refreshBtn").onclick = loadInventory;

function switchTab(tab){
  document.getElementById("tabInv").classList.toggle("active", tab==="inventory");
  document.getElementById("tabTally").classList.toggle("active", tab==="tally");
  document.getElementById("inventory").style.display = tab==="inventory" ? "block":"none";
  document.getElementById("tally").style.display = tab==="tally" ? "block":"none";
  document.body.style.background = tab==="inventory" ? "var(--gray-bg)" : "var(--light-bg)";
  document.body.style.color = tab==="inventory" ? "var(--text-light)" : "#222";
}

async function getJSON(url){ const r=await fetch(url); return r.json(); }
async function postJSON(body){
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  return r.json();
}

async function loadInventory(){
  document.getElementById("meta").textContent="Loading...";
  try{
    const data=await getJSON(`${API}?route=inventory`);
    invState=data.inventory||[];
    renderInventory();
    document.getElementById("meta").textContent=`Loaded ${invState.length} SKUs • ${new Date().toLocaleTimeString()}`;
  }catch(e){
    document.getElementById("meta").textContent="Error loading inventory";
    console.error(e);
  }
}

function weeksRemaining(goalDateStr){
  if(!goalDateStr) return null;
  const today=new Date(); const goal=new Date(goalDateStr);
  if(isNaN(goal)) return null;
  const diff=(goal - today)/(1000*3600*24*7);
  return Math.max(0, Math.ceil(diff));
}

function renderInventory(){
  const container=document.getElementById("invApp");
  container.innerHTML="";
  invState.forEach(r=>{
    const on=Number(r.On_Hand||0), res=Number(r.Reserved||0);
    const avail=Math.max(0,on-res);
    const goalStock=Number(r.Goal_Stock||0);
    const weeks=weeksRemaining(r.Goal_Date);
    const weekly=(goalStock && weeks)?Math.ceil(Math.max(0,goalStock-avail)/weeks):"–";
    const pct=(goalStock)?Math.min(100,(avail/goalStock)*100):0;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="row"><span class="sku">${r.SKU}</span></div>
      <div class="row"><span>On Hand</span><span class="qty">${on}</span></div>
      <div class="row"><span>Reserved</span><span class="qty">${res}</span></div>
      <div class="row"><span>Available</span><span class="qty">${avail}</span></div>
      <div class="row"><span>Goal Stock</span><span class="qty">${goalStock||"–"}</span></div>
      <div class="row"><span>Weeks Remaining</span><span class="qty">${weeks??"–"}</span></div>
      <div class="row"><span style="color:var(--brass)">Weekly Build Needed</span><span class="qty" style="color:var(--brass);font-weight:bold;">${weekly}</span></div>
      <div class="bar-container"><div class="bar-fill" style="width:${pct}%;"></div></div>
      <div class="row" style="gap:6px;margin-top:10px;flex-wrap:wrap;">
        <button class="tally-btn" onclick="adjustQty('${r.SKU}',1,this)">+</button>
        <button class="tally-btn" onclick="adjustQty('${r.SKU}',-1,this)">−</button>
        <button class="tally-btn" onclick="reserveQty('${r.SKU}',1,this)">Res</button>
        <button class="tally-btn" onclick="shipQty('${r.SKU}',1,this)">Ship</button>
      </div>`;
    container.appendChild(card);
  });
}

async function adjustQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"adjust",SKU:sku,Qty:qty}); loadInventory(); }
async function reserveQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"reserve",SKU:sku,Qty:qty}); loadInventory(); }
async function shipQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"ship",SKU:sku,Qty:qty}); loadInventory(); }
function animateBtn(b){ b.classList.add("loading"); setTimeout(()=>b.classList.remove("loading"),800); }

// ---------- TALLY TOOL ----------
function generateList(){
  const s=Number(document.getElementById("startNum").value);
  const e=Number(document.getElementById("endNum").value);
  const box=document.getElementById("checkboxes");
  const readout=document.getElementById("readout");
  box.innerHTML=""; readout.innerHTML="";
  if(isNaN(s)||isNaN(e)||e<s) return;
  const nums=[]; for(let i=s;i<=e;i++) nums.push(i);
  nums.reverse();
  nums.forEach(n=>{
    const id="num"+n;
    const label=document.createElement("label");
    label.innerHTML=`<input type="checkbox" id="${id}" onchange="updateReadout()"> ${n}`;
    box.appendChild(label);
    box.appendChild(document.createElement("br"));
  });
}
function updateReadout(){
  const box=document.getElementById("checkboxes");
  const checked=[...box.querySelectorAll("input:checked")].map(x=>Number(x.id.replace("num","")));
  const all=[...box.querySelectorAll("input")].map(x=>Number(x.id.replace("num","")));
  const out=document.getElementById("readout");
  let html="";
  all.forEach(n=>{
    const mark=checked.includes(n)?`<span class="checked">${n}</span>`:n;
    html+=mark+"<br>";
  });
  out.innerHTML=html;
}

switchTab("inventory");
loadInventory();
</script>
</body>
</html>
