<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SB Forge Inventory & Tally Tool</title>
<style>
  :root {
    --brass: #b99a5a;
    --gray-bg: #1e1e1e;
    --light-bg: #fafafa;
    --card-bg: #2b2b2b;
    --text-light: #f2f2f2;
    --muted: #aaa;
  }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    color: var(--text-light);
    background: var(--gray-bg);
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--card-bg);
    padding: 10px 16px;
    border-bottom: 1px solid #444;
  }
  header h1 {
    font-size: 1.1rem;
    margin: 0;
    color: var(--brass);
  }
  nav {
    display: flex;
    gap: 8px;
  }
  nav button {
    background: none;
    border: 1px solid var(--brass);
    color: var(--brass);
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }
  nav button.active {
    background: var(--brass);
    color: var(--gray-bg);
  }
  #refreshBtn {
    border: 1px solid var(--brass);
    color: var(--brass);
    background: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  /* Inventory Tab */
  #inventory {
    padding: 16px;
    display: none;
  }
  .card {
    background: var(--card-bg);
    border: 1px solid #3d3d3d;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 14px;
  }
  .sku {
    font-weight: bold;
    font-size: 1.1rem;
    color: var(--brass);
  }
  .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
  }
  .qty {
    font-variant-numeric: tabular-nums;
  }
  .bar-container {
    background: #3d3d3d;
    height: 8px;
    border-radius: 4px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    background: var(--brass);
    width: 0%;
    transition: width 0.5s ease;
  }
  .tally-btn {
    border: 1px solid var(--brass);
    background: none;
    color: var(--brass);
    padding: 10px;
    width: 46px;
    height: 46px;
    border-radius: 6px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
  }
  .tally-btn.loading::after {
    content: "";
    position: absolute;
    inset: 0;
    background: var(--brass);
    opacity: 0.2;
    width: 0%;
    animation: fill 0.8s linear forwards;
  }
  @keyframes fill { to { width: 100%; } }

  /* Tally Tab (light) */
  #tally {
    background: var(--light-bg);
    color: #222;
    padding: 16px;
    display: none;
    min-height: 100vh;
  }
  .tally-box {
    background: #fff;
    border: 1px solid #ccc;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .tally-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .tally-controls input[type="number"] {
    width: 90px;
    padding: 6px;
  }
  .tally-output {
    font-family: monospace;
    white-space: pre-wrap;
  }
  .checked {
    text-decoration: line-through;
    color: red;
  }
</style>
</head>
<body>
<header>
  <h1>SB Forge</h1>
  <nav>
    <button id="tabInv" class="active">Inventory</button>
    <button id="tabTally">Tally Tool</button>
  </nav>
  <button id="refreshBtn">Refresh</button>
</header>

<section id="inventory">
  <div id="meta" class="row" style="color:var(--muted); margin-bottom:8px;">Loading...</div>
  <div id="invApp"></div>
</section>

<section id="tally">
  <div class="tally-box">
    <h2>Tally Tool</h2>
    <div class="tally-controls">
      <label>Start: <input type="number" id="startNum" value="100"></label>
      <label>End: <input type="number" id="endNum" value="110"></label>
      <button onclick="generateList()">Generate</button>
    </div>
    <div id="checkboxes"></div>
    <h3>Readout:</h3>
    <div class="tally-output" id="readout"></div>
  </div>
</section>

<script>
const API = "/api/forward"; // uses Vercel proxy

let invState = [];
let localGoals = new Map();

document.getElementById("tabInv").onclick = () => switchTab("inventory");
document.getElementById("tabTally").onclick = () => switchTab("tally");
document.getElementById("refreshBtn").onclick = loadInventory;

function switchTab(tab){
  document.getElementById("tabInv").classList.toggle("active", tab==="inventory");
  document.getElementById("tabTally").classList.toggle("active", tab==="tally");
  document.getElementById("inventory").style.display = tab==="inventory" ? "block":"none";
  document.getElementById("tally").style.display = tab==="tally" ? "block":"none";
  document.body.style.background = tab==="inventory" ? "var(--gray-bg)" : "var(--light-bg)";
  document.body.style.color = tab==="inventory" ? "var(--text-light)" : "#222";
}

async function getJSON(url){ const r=await fetch(url); return r.json(); }
async function postJSON(body){
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  return r.json();
}

async function loadInventory(){
  document.getElementById("meta").textContent="Loading...";
  try{
    const data=await getJSON(`${API}?route=inventory`);
    invState=data.inventory||[];
    renderInventory();
    document.getElementById("meta").textContent=`Loaded ${invState.length} SKUs • ${new Date().toLocaleTimeString()}`;
  }catch(e){
    document.getElementById("meta").textContent="Error loading inventory";
    console.error(e);
  }
}

function weeksRemaining(goalDateStr){
  if(!goalDateStr) return null;
  const today=new Date(); const goal=new Date(goalDateStr);
  if(isNaN(goal)) return null;
  const diff=(goal - today)/(1000*3600*24*7);
  return Math.max(0, Math.ceil(diff));
}

function renderInventory(){
  const container=document.getElementById("invApp");
  container.innerHTML="";
  invState.forEach(r=>{
    const on=Number(r.On_Hand||0), res=Number(r.Reserved||0);
    const avail=Math.max(0,on-res);
    const goalStock=Number(r.Goal_Stock||0);
    const weeks=weeksRemaining(r.Goal_Date);
    const weekly=(goalStock && weeks)?Math.ceil(Math.max(0,goalStock-avail)/weeks):"–";
    const pct=(goalStock)?Math.min(100,(avail/goalStock)*100):0;

    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="row"><span class="sku">${r.SKU}</span></div>
      <div class="row"><span>On Hand</span><span class="qty">${on}</span></div>
      <div class="row"><span>Reserved</span><span class="qty">${res}</span></div>
      <div class="row"><span>Available</span><span class="qty">${avail}</span></div>
      <div class="row"><span>Goal Stock</span><span class="qty">${goalStock||"–"}</span></div>
      <div class="row"><span>Weeks Remaining</span><span class="qty">${weeks??"–"}</span></div>
      <div class="row"><span style="color:var(--brass)">Weekly Build Needed</span><span class="qty" style="color:var(--brass);font-weight:bold;">${weekly}</span></div>
      <div class="bar-container"><div class="bar-fill" style="width:${pct}%;"></div></div>
      <div class="row" style="gap:6px;margin-top:10px;flex-wrap:wrap;">
        <button class="tally-btn" onclick="adjustQty('${r.SKU}',1,this)">+</button>
        <button class="tally-btn" onclick="adjustQty('${r.SKU}',-1,this)">−</button>
        <button class="tally-btn" onclick="reserveQty('${r.SKU}',1,this)">Res</button>
        <button class="tally-btn" onclick="shipQty('${r.SKU}',1,this)">Ship</button>
      </div>`;
    container.appendChild(card);
  });
}

async function adjustQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"adjust",SKU:sku,Qty:qty}); loadInventory(); }
async function reserveQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"reserve",SKU:sku,Qty:qty}); loadInventory(); }
async function shipQty(sku,qty,btn){ animateBtn(btn); await postJSON({Action:"ship",SKU:sku,Qty:qty}); loadInventory(); }
function animateBtn(b){ b.classList.add("loading"); setTimeout(()=>b.classList.remove("loading"),800); }

// ---------- TALLY TOOL ----------
(function(){
  const ITEMS = [
    { key:'small', name:'Small', code:'S' },
    { key:'large', name:'Large', code:'L' },
    { key:'large_helper', name:'Large + Helper', code:'LH' },
    { key:'xl', name:'XL', code:'XL' },
    { key:'roaster', name:'Roaster', code:'R' },
    { key:'spatula', name:'Spatula', code:'SP' },
    { key:'tong', name:'Tong', code:'T' },
  ];

  const tbody = document.getElementById('tbody');

  for(const item of ITEMS){
    const tr = document.createElement('tr');
    tr.className = 'row';
    tr.dataset.item = item.key;

    const tdName = document.createElement('td');
    tdName.className = 'td';
    const nameWrap = document.createElement('div');
    nameWrap.className = 'name';
    const code = document.createElement('span');
    code.className = 'code'; code.textContent = item.code;
    const label = document.createElement('span');
    label.textContent = item.name;
    nameWrap.append(code, label);
    tdName.appendChild(nameWrap);

    const tdLetter = document.createElement('td');
    tdLetter.className = 'td';
    const codeSolo = document.createElement('div');
    codeSolo.className = 'code'; codeSolo.textContent = item.code;
    tdLetter.style.textAlign = 'center';
    tdLetter.appendChild(codeSolo);

    const tdStock = document.createElement('td');
    tdStock.className = 'td';
    tdStock.style.textAlign = 'center';
    const stock = document.createElement('input');
    stock.type = 'number'; stock.min = '0'; stock.step = '1';
    stock.placeholder = '0'; stock.dataset.field = `${item.key}:stock`;
    tdStock.appendChild(stock);

    const tdTally = document.createElement('td');
    tdTally.className = 'td';
    const talWrap = document.createElement('div');
    talWrap.className = 'tally';
    const minus = document.createElement('button'); minus.textContent = '–'; minus.title = `Decrement ${item.name}`;
    const count = document.createElement('div'); count.className = 'count'; count.textContent = '0'; count.tabIndex=0; count.dataset.field = `${item.key}:tally`;
    const plus = document.createElement('button'); plus.textContent = '+'; plus.title = `Increment ${item.name}`;
    talWrap.append(minus, count, plus);
    const status = document.createElement('div'); status.className = 'status'; status.dataset.statusFor = item.key;
    tdTally.append(talWrap, status);

    tr.append(tdName, tdLetter, tdStock, tdTally);
    tbody.appendChild(tr);

    // Editable count on click
    count.addEventListener('click', () => {
      const cur = parseInt(count.textContent || '0', 10) || 0;
      const next = prompt(`Set tally for ${item.name}:`, cur);
      if(next === null) return;
      const val = Math.max(0, parseInt(next,10)||0);
      count.textContent = String(val);
      saveField(`${item.key}:tally`, val);
      updateRow(item.key);
    });

    // +/- with 10s progress bar
    plus.addEventListener('click', () => { step(item.key, +1); showProgress(plus); });
    minus.addEventListener('click', () => { step(item.key, -1); showProgress(minus); });
  }

  function showProgress(btn){
    // Remove any existing progress bar and create a new one
    const old = btn.querySelector('.press-progress');
    if(old) old.remove();
    const bar = document.createElement('div');
    bar.className = 'press-progress';
    btn.appendChild(bar);
    // force reflow then animate
    void bar.offsetWidth;
    bar.style.width = '100%';
    // clean up after 10s
    setTimeout(() => { bar.remove(); }, 10050);
  }

  function saveField(key, value){ localStorage.setItem(`tally:${key}`, String(value)); }
  function loadField(key){ return localStorage.getItem(`tally:${key}`); }

  for(const item of ITEMS){
    const stockInput = tbody.querySelector(`[data-field="${item.key}:stock"]`);
    const tallyEl = tbody.querySelector(`[data-field="${item.key}:tally"]`);
    const s = loadField(`${item.key}:stock`);
    const t = loadField(`${item.key}:tally`);
    if(s !== null) stockInput.value = s;
    if(t !== null) tallyEl.textContent = t;
    updateRow(item.key);
  }

  tbody.addEventListener('input', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLElement)) return;
    const key = t.dataset?.field;
    if(!key) return;
    if(t.tagName === 'INPUT' && t.type === 'number'){
      const v = Math.max(0, parseInt(t.value || '0', 10) || 0);
      t.value = String(v);
      saveField(key, v);
      updateRow(key.split(':')[0]);
    }
  });

  function step(itemKey, delta){
    const countEl = tbody.querySelector(`[data-field="${itemKey}:tally"]`);
    let n = parseInt(countEl.textContent || '0', 10) || 0;
    n = Math.max(0, n + delta);
    countEl.textContent = String(n);
    saveField(`${itemKey}:tally`, n);
    updateRow(itemKey);
  }

  function updateRow(itemKey){
    const tr = tbody.querySelector(`.row[data-item="${itemKey}"]`);
    const stockVal = parseInt((tr.querySelector(`[data-field="${itemKey}:stock"]`)?.value)||'0',10)||0;
    const tallyVal = parseInt((tr.querySelector(`[data-field="${itemKey}:tally"]`)?.textContent)||'0',10)||0;
    const statusEl = tr.querySelector(`.status[data-status-for="${itemKey}"]`);
    tr.classList.remove('hit','over');
    statusEl.textContent = '';

    if(stockVal === 0){
      statusEl.textContent = 'Set stock to begin';
      return;
    }
    const remaining = stockVal - tallyVal;
    if(remaining > 0){
      statusEl.textContent = `Remaining: ${remaining}`;
    } else if(remaining === 0){
      statusEl.textContent = `OUT`;
      tr.classList.add('hit');
      flash(tr);
    } else {
      statusEl.textContent = `Over by ${Math.abs(remaining)}`;
      tr.classList.add('over');
    }
  }

  function flash(el){
    el.animate(
      [{boxShadow:'0 0 0 0 rgba(22,163,74,0.0)'},{boxShadow:'0 0 0 14px rgba(22,163,74,0.18)'}],
      {duration:320, direction:'alternate', iterations:2}
    );
  }

  document.getElementById('resetTallies').addEventListener('click', ()=>{
    if(!confirm('Reset ALL tallies to 0?')) return;
    for(const item of ITEMS){
      const el = tbody.querySelector(`[data-field="${item.key}:tally"]`);
      el.textContent = '0'; saveField(`${item.key}:tally`, 0); updateRow(item.key);
    }
  });
  document.getElementById('clearAll').addEventListener('click', ()=>{
    if(!confirm('Clear EVERYTHING (stock & tallies)?')) return;
    for(const item of ITEMS){
      tbody.querySelector(`[data-field="${item.key}:stock"]`).value = '';
      tbody.querySelector(`[data-field="${item.key}:tally"]`).textContent = '0';
      saveField(`${item.key}:stock`, '');
      saveField(`${item.key}:tally`, 0);
      updateRow(item.key);
    }
  });

  // ===== Orders by Range (v4) =====
  const startNum = document.getElementById('startNum');
  const endNum = document.getElementById('endNum');
  const genRange = document.getElementById('genRange');
  const checkboxList = document.getElementById('checkboxList');
  const readoutList = document.getElementById('readoutList');
  const copySelectedBtn = document.getElementById('copySelected');
  const copyAllLinesBtn = document.getElementById('copyAllLines');
  const selectAllBtn = document.getElementById('selectAll');
  const clearSelectedBtn = document.getElementById('clearSelected');
  const orderCount = document.getElementById('orderCount');
  const orderCountMeta = document.getElementById('orderCountMeta');

  // Load saved state
  const savedStart = localStorage.getItem('tally:orders:start');
  const savedEnd = localStorage.getItem('tally:orders:end');
  const savedSelected = JSON.parse(localStorage.getItem('tally:orders:selected') || '[]');
  if(savedStart) startNum.value = savedStart;
  if(savedEnd) endNum.value = savedEnd;
  if(savedStart && savedEnd){
    renderRange(savedStart, savedEnd, new Set(savedSelected));
  }

  function normalizeNum(s){
    if(!s) return null;
    s = String(s).trim();
    if(s.startsWith('#')) s = s.slice(1);
    const n = parseInt(s, 10);
    return Number.isFinite(n) ? n : null;
  }

  genRange.addEventListener('click', ()=>{
    const s = normalizeNum(startNum.value);
    const e = normalizeNum(endNum.value);
    if(s === null || e === null){ alert('Enter a valid numeric range, e.g. #4560 to #4576'); return; }
    const smin = Math.min(s,e), smax = Math.max(s,e);
    localStorage.setItem('tally:orders:start', '#' + smin);
    localStorage.setItem('tally:orders:end', '#' + smax);
    const prevSel = new Set(JSON.parse(localStorage.getItem('tally:orders:selected') || '[]'));
    const nextSel = new Set([...prevSel].filter(n => n >= smin && n <= smax));
    renderRange('#'+smin, '#'+smax, nextSel);
  });

  function renderRange(startStr, endStr, selectedSet){
    checkboxList.innerHTML = '';
    readoutList.innerHTML = '';
    const s = normalizeNum(startStr);
    const e = normalizeNum(endStr);
    const smin = Math.min(s,e), smax = Math.max(s,e);

    // Left: checkbox lines, descending
    for(let n = smax; n >= smin; n--){
      const line = document.createElement('label');
      line.className = 'checkbox-line';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.order = String(n);
      cb.checked = selectedSet.has(n);
      cb.addEventListener('change', onToggle);
      line.appendChild(cb);
      line.appendChild(document.createTextNode('#'+n));
      checkboxList.appendChild(line);
    }

    // Right: readout lines, descending, strikethrough red for unselected
    for(let n = smax; n >= smin; n--){
      const div = document.createElement('div');
      div.className = 'order-line' + (selectedSet.has(n) ? '' : ' unselected');
      div.dataset.order = String(n);
      div.textContent = '#'+n;
      readoutList.appendChild(div);
    }

    saveSelected(selectedSet);
    updateCounters(selectedSet, smin, smax);
  }

  function onToggle(e){
    const cb = e.target;
    const n = parseInt(cb.dataset.order, 10);
    const sel = new Set(JSON.parse(localStorage.getItem('tally:orders:selected') || '[]'));
    if(cb.checked) sel.add(n); else sel.delete(n);
    saveSelected(sel);
    // mirror in readout
    const line = readoutList.querySelector(`.order-line[data-order="${n}"]`);
    if(line){
      line.classList.toggle('unselected', !cb.checked);
    }
    const s = normalizeNum(localStorage.getItem('tally:orders:start'));
    const e2 = normalizeNum(localStorage.getItem('tally:orders:end'));
    if(s!==null && e2!==null){
      updateCounters(sel, Math.min(s,e2), Math.max(s,e2));
    }
  }

  function saveSelected(set){
    const arr = Array.from(set).sort((a,b)=>a-b);
    localStorage.setItem('tally:orders:selected', JSON.stringify(arr));
  }

  function updateCounters(set, smin, smax){
    const total = smax - smin + 1;
    const selected = set.size;
    orderCount.textContent = selected;
    orderCountMeta.textContent = `selected of ${total} total`;
  }

  // Copy helpers
  copySelectedBtn.addEventListener('click', async ()=>{
    const sel = new Set(JSON.parse(localStorage.getItem('tally:orders:selected') || '[]'));
    const numbersDesc = Array.from(sel).sort((a,b)=>b-a).map(n => '#'+n).join('\n');
    try{
      await navigator.clipboard.writeText(numbersDesc);
      copySelectedBtn.textContent = 'Copied!';
      setTimeout(()=>copySelectedBtn.textContent='Copy Selected', 1200);
    }catch{ alert('Could not copy. Select text and copy manually.'); }
  });

  copyAllLinesBtn.addEventListener('click', async ()=>{
    const s = normalizeNum(localStorage.getItem('tally:orders:start'));
    const e = normalizeNum(localStorage.getItem('tally:orders:end'));
    if(s===null || e===null){ alert('Generate a range first.'); return; }
    const smin = Math.min(s,e), smax = Math.max(s,e);
    const sel = new Set(JSON.parse(localStorage.getItem('tally:orders:selected') || '[]'));
    const lines = [];
    for(let n = smax; n >= smin; n--){
      const picked = sel.has(n);
      // markdown ~~ for unselected
      lines.push((picked ? '' : '~~') + '#'+n + (picked ? '' : '~~'));
    }
    const text = lines.join('\n');
    try{
      await navigator.clipboard.writeText(text);
      copyAllLinesBtn.textContent = 'Copied!';
      setTimeout(()=>copyAllLinesBtn.textContent='Copy All Lines', 1200);
    }catch{ alert('Could not copy. Select text and copy manually.'); }
  });

  // Bulk controls
  selectAllBtn.addEventListener('click', ()=>{
    const inputs = checkboxList.querySelectorAll('input[type="checkbox"]');
    const sel = new Set();
    inputs.forEach(cb => { cb.checked = true; sel.add(parseInt(cb.dataset.order, 10)); });
    saveSelected(sel);
    // update list
    readoutList.querySelectorAll('.order-line').forEach(div => div.classList.remove('unselected'));
    const s = normalizeNum(localStorage.getItem('tally:orders:start'));
    const e2 = normalizeNum(localStorage.getItem('tally:orders:end'));
    if(s!==null && e2!==null){
      updateCounters(sel, Math.min(s,e2), Math.max(s,e2));
    }
  });

  clearSelectedBtn.addEventListener('click', ()=>{
    const inputs = checkboxList.querySelectorAll('input[type="checkbox"]');
    inputs.forEach(cb => cb.checked = false);
    const sel = new Set();
    saveSelected(sel);
    // update list
    readoutList.querySelectorAll('.order-line').forEach(div => div.classList.add('unselected'));
    const s = normalizeNum(localStorage.getItem('tally:orders:start'));
    const e2 = normalizeNum(localStorage.getItem('tally:orders:end'));
    if(s!==null && e2!==null){
      updateCounters(sel, Math.min(s,e2), Math.max(s,e2));
    }
  });

})();
</script>
</body>
</html>
