<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SB Forge Inventory + Tally Tool</title>
<style>
:root{
  --brass:#c4a25a;
  --brass-light:#d8b96a;
  --bg-dark:#1e1e1e;
  --bg-card:#2b2b2b;
  --bg-light:#f8f8f9;
  --text-light:#f2f2f2;
  --text-dark:#111;
  --muted:#aaa;
  --border:#3d3d3d;
}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg-dark);color:var(--text-light);}
header{display:flex;justify-content:space-between;align-items:center;background:var(--bg-card);padding:10px 16px;border-bottom:1px solid var(--border);}
header h1{margin:0;font-size:1.1rem;color:var(--brass);}
nav{display:flex;gap:8px;}
nav button,#refreshBtn{
  border:1px solid var(--brass);background:none;color:var(--brass);
  padding:6px 12px;border-radius:6px;cursor:pointer;font-weight:600;
}
nav button.active{background:var(--brass);color:var(--bg-dark);}
#refreshBtn:hover{background:var(--brass-light);color:var(--bg-dark);}
section{display:none;padding:16px;}
#inventory{background:var(--bg-dark);}
#tally{background:var(--bg-light);color:var(--text-dark);min-height:100vh;}
.card{
  background:var(--bg-card);border:1px solid var(--border);border-radius:12px;
  padding:16px;margin-bottom:14px;
}
.sku{color:var(--brass);font-weight:700;font-size:1.1rem;}
.row{display:flex;justify-content:space-between;align-items:center;margin:6px 0;}
.qty{font-variant-numeric:tabular-nums;}
.bar-container{background:#3d3d3d;height:8px;border-radius:4px;overflow:hidden;margin-top:4px;}
.bar-fill{height:100%;background:var(--brass-light);width:0%;transition:width .6s;}
.week-dots{display:flex;gap:4px;margin-top:4px;}
.dot{width:6px;height:6px;border-radius:50%;background:#555;}
.dot.active{background:var(--brass);}
.controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:6px;}
.ctrl-group{display:flex;align-items:center;gap:4px;}
.ctrl-btn{
  width:38px;height:38px;border:1px solid var(--brass);border-radius:6px;
  background:var(--bg-dark);color:var(--brass);font-weight:700;cursor:pointer;
  position:relative;overflow:hidden;
}
.ctrl-btn.loading::after{
  content:"";position:absolute;inset:0;background:var(--brass-light);opacity:.2;
  width:0%;animation:fill .8s linear forwards;
}
@keyframes fill{to{width:100%;}}
.ctrl-input{
  width:60px;background:var(--bg-card);border:1px solid var(--border);color:var(--text-light);
  border-radius:6px;text-align:center;padding:4px 6px;font-weight:700;
}
.manual-onhand{margin-top:8px;}
.manual-onhand input{
  width:70px;background:var(--bg-card);border:1px solid var(--border);
  color:var(--text-light);border-radius:6px;text-align:center;padding:4px 6px;font-weight:700;
}
.manual-onhand button{
  border:1px solid var(--brass);color:var(--brass);background:none;border-radius:6px;
  padding:4px 8px;cursor:pointer;
}

/* TALLY TOOL STYLE */
.tally-box{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 4px 14px rgba(0,0,0,0.05);}
.tally-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0;padding-bottom:6px;border-bottom:1px solid #eee;}
.tally-row:last-child{border-bottom:none;}
.tally-name{font-weight:700;width:140px;}
.tally-stock{width:60px;text-align:center;}
.tally-ctrl{display:flex;align-items:center;gap:4px;}
.tally-count{width:60px;text-align:center;font-weight:700;border:1px solid #ddd;border-radius:8px;padding:4px;}
.tally-btn{
  width:38px;height:38px;border:1px solid var(--brass);border-radius:8px;background:#fff;color:var(--brass);font-weight:700;cursor:pointer;position:relative;overflow:hidden;
}
.tally-btn.loading::after{content:"";position:absolute;inset:0;background:var(--brass);opacity:.2;width:0%;animation:fill 1s linear forwards;}
.ship-btn{
  margin-top:20px;width:100%;padding:12px;font-size:1.1rem;font-weight:700;
  border:none;border-radius:10px;background:var(--brass);color:var(--bg-dark);cursor:pointer;
}
#shipStatus{text-align:center;margin-top:8px;font-weight:600;color:#16a34a;}
</style>
</head>
<body>
<header>
  <h1>SB Forge</h1>
  <nav>
    <button id="tabInv" class="active">Inventory</button>
    <button id="tabTally">Tally Tool</button>
  </nav>
  <button id="refreshBtn">Refresh</button>
</header>

<section id="inventory">
  <div id="meta" class="row" style="color:var(--muted);margin-bottom:8px;">Loading...</div>
  <div id="invApp"></div>
</section>

<section id="tally">
  <div class="tally-box">
    <h2>Shipping Tally</h2>
    <div id="tallyApp"></div>
    <button id="shipAll" class="ship-btn">SHIPPED</button>
    <div id="shipStatus"></div>
  </div>
</section>

<script>
const API="/api/forward";
const SKU_ORDER=["Small","Large","Large + Helper","Roaster","XL","Spatula","Tongs"];
let invState=[];

document.getElementById("tabInv").onclick=()=>switchTab("inventory");
document.getElementById("tabTally").onclick=()=>switchTab("tally");
document.getElementById("refreshBtn").onclick=loadInventory;
document.getElementById("shipAll").onclick=shipAll;

function switchTab(tab){
  document.getElementById("tabInv").classList.toggle("active",tab==="inventory");
  document.getElementById("tabTally").classList.toggle("active",tab==="tally");
  document.getElementById("inventory").style.display=tab==="inventory"?"block":"none";
  document.getElementById("tally").style.display=tab==="tally"?"block":"none";
  document.body.style.background=tab==="inventory"?"var(--bg-dark)":"var(--bg-light)";
  document.body.style.color=tab==="inventory"?"var(--text-light)":"var(--text-dark)";
  if(tab==="tally") renderTally();
}

async function getJSON(url){const r=await fetch(url);return r.json();}
async function postJSON(body){const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});return r.json();}

async function loadInventory(){
  document.getElementById("meta").textContent="Loading...";
  try{
    const data=await getJSON(`${API}?route=inventory`);
    invState=data.inventory||[];
    invState.sort((a,b)=>SKU_ORDER.indexOf(a.SKU)-SKU_ORDER.indexOf(b.SKU));
    renderInventory();
    document.getElementById("meta").textContent=`Loaded ${invState.length} SKUs • ${new Date().toLocaleTimeString()}`;
  }catch(e){
    console.error(e);
    document.getElementById("meta").textContent="Error loading inventory";
  }
}

function weeksRemaining(goalDateStr){
  if(!goalDateStr)return null;
  const today=new Date();const goal=new Date(goalDateStr);
  if(isNaN(goal))return null;
  return Math.max(0,Math.ceil((goal-today)/(1000*3600*24*7)));
}

function renderInventory(){
  const container=document.getElementById("invApp");
  container.innerHTML="";
  invState.forEach(r=>{
    const on=+r.On_Hand||0,res=+r.Reserved||0;
    const avail=Math.max(0,on-res);
    const goalStock=+r.Goal_Stock||0;
    const weeks=weeksRemaining(r.Goal_Date);
    const weekly=(goalStock&&weeks)?Math.ceil(Math.max(0,goalStock-avail)/weeks):"–";
    const pct=goalStock?Math.min(100,(avail/goalStock)*100):0;
    const card=document.createElement("div");
    card.className="card";
    const weekDots=new Array(weeks||0).fill(0).map((_,i)=>`<div class="dot ${i<weeks?"" :""}"></div>`).join("");
    card.innerHTML=`
      <div class="sku">${r.SKU}</div>
      <div class="row"><span>On Hand</span><span class="qty">${on}</span></div>
      <div class="row"><span>Reserved</span><span class="qty">${res}</span></div>
      <div class="row"><span>Available</span><span class="qty">${avail}</span></div>
      <div class="row"><span>Goal Stock</span><span class="qty">${goalStock||"–"}</span></div>
      <div class="row"><span>Weeks Remaining</span><span class="qty">${weeks??"–"}</span></div>
      <div class="row"><span style="color:var(--brass)">Weekly Build Needed</span><span style="color:var(--brass);font-weight:bold;">${weekly}</span></div>
      <div class="bar-container"><div class="bar-fill" style="width:${pct}%;"></div></div>
      <div class="week-dots">${weekDots}</div>
      <div class="controls">
        <div class="ctrl-group">
          <button class="ctrl-btn" onclick="adjustQty('${r.SKU}',-1,this)">−</button>
          <input type="number" class="ctrl-input" id="input-${r.SKU}" value="0" min="0" step="1">
          <button class="ctrl-btn" onclick="adjustQty('${r.SKU}',1,this)">+</button>
        </div>
        <button class="ctrl-btn" onclick="reserveQty('${r.SKU}',1,this)">Res</button>
        <button class="ctrl-btn" onclick="shipQty('${r.SKU}',1,this)">Ship</button>
      </div>
      <div class="manual-onhand">
        <label>Manual On-Hand: <input id="manual-${r.SKU}" type="number" value="${on}" min="0" step="1"></label>
        <button onclick="saveManual('${r.SKU}')">Save</button>
      </div>`;
    container.appendChild(card);
  });
}

async function adjustQty(sku,delta,btn){
  animateBtn(btn);
  const val=parseInt(document.getElementById(`input-${sku}`).value||"0",10);
  const amt=Math.max(1,val||1)*delta;
  await postJSON({Action:"adjust",SKU:sku,Qty:amt});
  loadInventory();
}
async function reserveQty(sku,qty,btn){animateBtn(btn);await postJSON({Action:"reserve",SKU:sku,Qty:qty});loadInventory();}
async function shipQty(sku,qty,btn){animateBtn(btn);await postJSON({Action:"ship",SKU:sku,Qty:qty});loadInventory();}
async function saveManual(sku){
  const val=parseInt(document.getElementById(`manual-${sku}`).value||"0",10);
  await postJSON({Action:"set_onhand",SKU:sku,Qty:val});
  loadInventory();
}
function animateBtn(b){b.classList.add("loading");setTimeout(()=>b.classList.remove("loading"),900);}

/* ---------- TALLY TOOL ---------- */
function renderTally(){
  const container=document.getElementById("tallyApp");
  container.innerHTML="";
  SKU_ORDER.forEach(name=>{
    const row=document.createElement("div");row.className="tally-row";
    const inv=invState.find(x=>x.SKU===name);
    const stock=inv?+inv.On_Hand||0:0;
    row.innerHTML=`
      <div class="tally-name">${name}</div>
      <div class="tally-stock">${stock}</div>
      <div class="tally-ctrl">
        <button class="tally-btn" onclick="tallyStep('${name}',-1,this)">−</button>
        <input type="number" class="tally-count" id="tally-${name}" value="0" min="0" step="1">
        <button class="tally-btn" onclick="tallyStep('${name}',1,this)">+</button>
      </div>`;
    container.appendChild(row);
  });
}
function tallyStep(name,delta,btn){
  animateBtn(btn);
  const el=document.getElementById(`tally-${name}`);
  let n=parseInt(el.value||"0",10)||0;
  n=Math.max(0,n+delta);
  el.value=n;
}
async function shipAll(){
  const btn=document.getElementById("shipAll");
  const status=document.getElementById("shipStatus");
  if(!confirm("Confirm ship tallied quantities?"))return;
  const payloads=[];
  SKU_ORDER.forEach(name=>{
    const n=parseInt(document.getElementById(`tally-${name}`).value||"0",10)||0;
    if(n>0)payloads.push({Action:"ship",SKU:name,Qty:n});
  });
  if(payloads.length===0){alert("No tallies to ship.");return;}
  btn.disabled=true;status.textContent="Processing...";
  try{
    await Promise.all(payloads.map(p=>postJSON(p)));
    status.textContent="Shipment logged ✅";
    SKU_ORDER.forEach(n=>document.getElementById(`tally-${n}`).value=0);
    loadInventory();
    setTimeout(()=>{status.textContent="";btn.disabled=false;},2000);
  }catch(e){console.error(e);status.textContent="Error processing shipment";btn.disabled=false;}
}

switchTab("inventory");
loadInventory();
</script>
</body>
</html>
